<html>
  <head>
    <title>Turnus</title>
    <LINK href="style.css" rel="stylesheet" type="text/css">
  </head>

<?php

include 'config.php';
include 'opendb.php';

include 'request.php';


if ($action == 'insert')
{
   $query = "insert into shift (id_person, id_project, status) " .
            "values ('$_REQUEST[id_person]', '$_REQUEST[id_project]', '1')";
   mysql_query($query);
}   

if ($action == 'update')
{
   $next_status = intval($_REQUEST[status]) + 1;
   if ($next_status > 4)
     $next_status = 0;

   $query = "update shift set status = $next_status " .
             "where id_person = $_REQUEST[id_person] " .
             "and id_project = $_REQUEST[id_project]";
   mysql_query($query);
}   

$sel_year = ($_REQUEST[from] == NULL) ? date("Y") : intval($_REQUEST[from]);
$prev_year = $sel_year - 1;

echo "<body BGCOLOR=FFFFF4 TEXT=000000 LINK=00009F VLINK=008B00 ALINK=890000>
    <h1>Turnus</h1>
    <table border=1>
    <tr>
      <th bgcolor=#A6CAF0><a href=\"$_SERVER[PHP_SELF]?from=$prev_year&id_person={$row[person_id]}&id_project={$row[project_id]}&status={$status}&_sort={$sort}\"><img src=/images/left.gif border=0 title=\"Forrige &aring;r...\"></a> <a href=shift.php?from=$sel_year&_sort=firstname,lastname target=content title=\"Sorter p&aring; fornavn...\">Fornavn</a>/<a href=shift.php?from=$sel_year&_sort=lastname,firstname target=content title=\"Sorter p&aring; etternavn...\">Etternavn</a></th>
      <th bgcolor=#A6CAF0><a href=shift.php?from=$sel_year&_sort=list_order,lastname,firstname target=content title=\"Sorter p&aring; instrumentgruppe...\">Instrument</a></th>";

$query  = "SELECT id, name, semester, year " .
          "FROM project " .
          "where year >= $sel_year " .
          "order by year, semester DESC, project.id";
$result = mysql_query($query);

while($row = mysql_fetch_array($result, MYSQL_ASSOC))
  echo "<th bgcolor=#A6CAF0><a href=plan.php?_sort=time,date&id_project={$row[id]} target=content>{$row[name]}<br>{$row[semester]}{$row[year]}</a></td>";
echo "</tr><tr>";

if ($sort == NULL)
  $sort = "(select IFNULL(max(id_project), 0) from shift where id_person = person.id and status = 2), list_order, lastname, firstname ";

$query  = "SELECT person.id as person_id, " .
          "person.table_ok as table_ok, " .
          "project.id as project_id,  " .
          "project.name as project_name, " .
          "firstname, lastname, instrument, " .
          "person.comment as comment " .
          "FROM person, instruments, project " .
          "where instruments.id = id_instrument " .
          "and person.status = 'aktiv' " .
          "and project.year >= $sel_year " .
          "order by $sort, year, semester DESC, project.id";
$result = mysql_query($query);

$prev_id = 0;

$status_tab = array(
  0 => "Klikk for &aring; bli valgt inn i regikomiteen",
  1 => "Tentativt",
  2 => "Bekreftet",
  3 => "Ikke godkjent oppm&oslash;te",
  4 => "Permisjon"
);

while($row = mysql_fetch_array($result, MYSQL_ASSOC))
{
  if ($row[person_id] != $prev_id)
  {
    echo "</tr><tr><td bgcolor=#A6CAF0><a href=history.php?id_person=$row[person_id] title=\"$row[comment]\">$row[firstname] $row[lastname]</a>";   
    if ($row[table_ok] == '')
      echo " <img src=\"/images/chair-minus-icon.png\" border=0 title=\"Kan ikke l&oslash;fte bord\"></h2>";
    echo "</td><td bgcolor=#A6CAF0> $row[instrument] </td>";
    $prev_id = $row[person_id];
  }
  $query  = "SELECT status, comment from shift " .
          "where id_project = {$row[project_id]} " .
          "and id_person = {$row[person_id]}"; 
  $result2 = mysql_query($query);
  $status = 0;
  $action = "insert";
  if ($row2 = mysql_fetch_array($result2, MYSQL_ASSOC))
  {
    $status = $row2[status];
    $comment = $row2[comment];
    $action = "update";
  }

  echo "<td align=center><a href=\"$_SERVER[PHP_SELF]?_action={$action}&id_person={$row[person_id]}&id_project={$row[project_id]}&status={$status}&from=$sel_year&_sort={$sort}\"><img src=\"shift_status_{$status}.gif\" border=0 title=\"{$status_tab[$status]} ({$row[project_name]}) {$comment}\"></a></td>";
} 

include 'closedb.php';

?> 
    </tr>
    </table>
  </body>
</html>

