<html>
  <head>
    <title>Person</title>
    <LINK href="style.css" rel="stylesheet" type="text/css">
  </head>

<?php

include 'config.php';
include 'opendb.php';

include 'request.php';

function mail2all()
{
  $q = "select email from person " .
       "where (status = 'Aktiv' or status = 'Fritatt')";
  $r = mysql_query($q);

  echo "<a href=\"mailto:?bcc=";
  while ($e = mysql_fetch_array($r, MYSQL_ASSOC))
    echo $e[email] . ",";
  echo "&subject=OSO: \"><image border=0 src=/images/image1.gif hspace=20 title=\"Send mail alle i OSO med status aktiv eller fritatt\"></a>";
}

function select_instrument($selected)
{
  $q  = "SELECT id, instrument FROM instruments order by list_order";
  $r = mysql_query($q);

  while($e = mysql_fetch_array($r, MYSQL_ASSOC))
  {
    echo "<option value=\"" . $e[id] . "\"";
    if ($e[id] == $selected)
      echo " selected";
    echo ">" . $e[instrument];
  }
}

function select_status($selected)
{
  $a = array("Aktiv", 
             "Permisjon",
             "Vikar",
             "Fritatt",
             "Sluttet");

  foreach ($a as $status)
  {
    echo "<option";
    if ($selected == $status)
      echo " selected";
    echo ">$status</option>\n";
  }
}

function format_phone($ph)
{
  $ph = str_replace(' ', '', $ph);
  $ph = substr($ph, 0, -5) . " " . substr($ph, -5, 2) . " " . substr($ph, -3);
  if (strlen($ph) > 9)
    $ph = substr($ph, 0, -10) . " " . substr($ph, -10);
  return $ph;
}

echo "
  <body BGCOLOR=FFFFF4 TEXT=000000 LINK=00009F VLINK=008B00 ALINK=890000>
    <h1>Person</h1>";
echo "
    <form action='$php_self' method=post>
      <input type=hidden name=_sort value='$sort'>
      <input type=hidden name=_action value=new>
      <input type=submit value=\"Ny person\">";
    mail2all();
echo "
    </form>
    <form action='$php_self' method=post>
    <table border=1>
    <tr>
      <th bgcolor=#A6CAF0>Edit</th>
      <th bgcolor=#A6CAF0><a href=\"$php_self?_sort=list_order,lastname,firstname\">Instrument</a></th>
      <th bgcolor=#A6CAF0><a href=\"{$php_self}?_sort=firstname,lastname\">For</a>/
                          <a href=\"{$php_self}?_sort=lastname,firstname\">Etternavn</a></th>
      <th bgcolor=#A6CAF0><a href=\"{$php_self}?_sort=email\">Mail</a>";
echo "</th>
      <th bgcolor=#A6CAF0>Mobil</th>
      <th bgcolor=#A6CAF0><a href=\"{$php_self}?_sort=status,list_order,lastname,firstname\">Status</a></th>
      <th bgcolor=#A6CAF0>Bord</th>
      <th bgcolor=#A6CAF0>Merknad</th>
      </tr>";


if ($action == 'new')
{
  echo "  <tr>
    <td align=left><input type=hidden name=_action value=update>
    <input type=hidden name=_sort value='$sort'>
    <input type=submit value=ok></td>
    <th><select name=id_instrument>";
  select_instrument(null);
  echo "</select></th>
    <th nowrap><input type=text size=10 name=firstname>
    <input type=text size=10 name=lastname></th>
    <th align=left><input type=text size=35 name=email></th>
    <th><input type=text size=11 name=phone></th>
    <th><select name=status>";
  select_status(null);
  echo "</select></th>
    <th><input type=checkbox name=table_ok value='*' checked></th>
    <th><input type=text size=40 name=comment></th>
  </tr>";
}

if ($action == 'update')
{
  if ($no == NULL)
    $query = "insert into person (id_instrument, firstname, lastname, email,
              phone, status, table_ok, comment)
              values ('$_POST[id_instrument]', '$_POST[firstname]', 
                      '$_POST[lastname]',
                      '$_POST[email]', '$_POST[phone]', 
                      '$_POST[status]', '$_POST[table_ok]', '$_POST[comment]')";
  else
  {
    if ($delete != NULL)
    {
      $query = "DELETE FROM person WHERE id = $no";
      $query2 = "delete from shift where id_person = $no";
      mysql_query($query2);
      $query3 = "delete from resource where id_person = $no";
      mysql_query($query3);
    }
    else
      $query = "update person set id_instrument = '$_POST[id_instrument]'," .
                               "firstname = '$_POST[firstname]'," .
                               "lastname = '$_POST[lastname]'," .
                               "email = '$_POST[email]'," .
                               "phone = '$_POST[phone]'," .
                               "status = '$_POST[status]'," .
                               "table_ok = '$_POST[table_ok]'," .
                               "comment = '$_POST[comment]' " .
             "where id = $no";
    $no = NULL;
  }
  mysql_query($query);
}   


$query  = "SELECT person.id as id, id_instrument, instrument, firstname, lastname, " .
    "email, phone, status, table_ok, person.comment as comment " .
    "FROM person, instruments where id_instrument = instruments.id order by ${sort}";

$result = mysql_query($query);

while($row = mysql_fetch_array($result, MYSQL_ASSOC))
{
  if ($row[id] != $no)
  {
    echo "<tr>
         <td><center>
           <a href=\"{$php_self}?_sort={$sort}&_action=view&_no={$row[id]}\"><img src=\"/images/cross_re.gif\" border=0 title=\"Klikk for &aring; editere...\"></a>
             </center></td>" .
         "<td>{$row[instrument]}</td>" .
         "<td><a href=history.php?id_person=$row[id]>{$row[firstname]} " .
         "{$row[lastname]}</a></td>" . 
         "<td><a href=\"mailto:{$row[email]}?subject=$concept - $project\">{$row[email]}</a></td>" .
         "<td nowrap>" . format_phone($row[phone]) . "</a></td>" .     
         "<td>{$row[status]}</td>" .
         "<td>";
    if ($row[table_ok] == '*')
      echo "<center><img src=\"/images/tick2.gif\" border=0></center>";
    if ($row[table_ok] == '')
      echo "<center><img src=\"/images/chair-minus-icon.png\" border=0 title=\"Kan ikke l&oslash;fte bord\"></center>";
    echo "</td>" .
         "<td>{$row[comment]}</td>" .
         "</tr>";
  }
  else
  {
    echo "<tr>
    <input type=hidden name=_action value=update>
    <input type=hidden name=_sort value='$sort'>
    <input type=hidden name=_no value='$no'>
    <th nowrap><input type=submit value=ok>
    <input type=submit value=del name=_delete onClick=\"return confirm('Sikkert at du vil slette {$row[firstname]} {$row[lastname]}?');\"></th>
    <th><select name=id_instrument>";
  select_instrument($row[id_instrument]);
  echo "</select></th>
    <th nowrap><input type=text size=10 name=firstname value=\"{$row[firstname]}\">
    <input type=text size=10 name=lastname value=\"{$row[lastname]}\"></th>
    <th align=left><input type=text size=35 name=email value=\"{$row[email]}\"></th>
    <th><input type=text size=11 maxlength=11 name=phone value=\"{$row[phone]}\"></th>
    <th><select name=status>";
  select_status($row[status]);
  echo "</select></th>
    <th><input type=checkbox name=table_ok value='*'";
  if ($row[table_ok] != '')
    echo " checked";
  echo "></th>
    <th><input type=text size=40 name=comment value=\"{$row[comment]}\"></th>
    </tr>";
  }
} 

include 'closedb.php';

?> 

    </table>
    </form>
  </body>
</html>

